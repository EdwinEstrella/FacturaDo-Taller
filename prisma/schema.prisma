generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Client {
  id        String         @id @default(cuid())
  name      String
  rnc       String?        // RNC or Cedula
  address   String?
  phone     String?
  email     String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  invoices  Invoice[]
  quotes    Quote[]
  history   ClientHistory[]
}

model ClientHistory {
  id          String   @id @default(cuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  action      String   // CREATED, UPDATED, INVOICE_CREATED, INVOICE_PAID, QUOTE_CREATED
  description String?  // Detalles de la acci贸n
  metadata    String?  // JSON para datos adicionales
  createdAt   DateTime @default(now())

  @@index([clientId, createdAt])
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Decimal
  cost        Decimal  @default(0) // Purchase Price
  stock       Int      @default(0)
  minStock    Int      @default(0)
  isService   Boolean  @default(false) // Deprecated in favor of category, or kept for compat
  category    String   @default("ARTICULO") // MATERIAL, ARTICULO, SERVICIO
  sku         String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]
  variants     ProductVariant[]
  hasVariants  Boolean @default(false)
  purchaseItems PurchaseItem[]
}

model ProductVariant {
  id          String         @id @default(cuid())
  productId   String
  product     Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String         // e.g. "Red / XL" or just "XL"
  price       Decimal
  cost        Decimal        @default(0)
  stock       Int            @default(0)
  sku         String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  invoiceItems InvoiceItem[]
  quoteItems   QuoteItem[]
  
  @@index([productId])
}

model Invoice {
  id              String        @id @default(cuid())
  sequenceNumber  Int           @default(autoincrement()) // Internal sequence
  ncf             String?       // Comprobante Fiscal
  ncfType         String?       // Type of NCF (Fiscal, Consumo, etc.)
  clientId        String?
  client          Client?       @relation(fields: [clientId], references: [id])
  clientName      String?       // Snapshot in case client is deleted/null
  total           Decimal
  status          String        @default("PAID") // PAID, PENDING, CANCELLED
  paymentMethod   String?       // PROPOSED: cash, card, transfer
  items           InvoiceItem[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  note            String?
  
  // Logistics
  dispatched      Boolean       @default(false)
  dispatchInfo    Dispatch?
  workOrder       WorkOrder?
  
  // Auditing
  createdById     String?
  createdBy       User?         @relation(fields: [createdById], references: [id], onDelete: SetNull)
  creatorName     String?       // Snapshot name

  // New Fields for Enhanced Invoices
  shippingCost Decimal  @default(0)
  deliveryDate DateTime?
  notes        String?
  balance      Decimal  @default(0) // For Receivables
  tax          Decimal  @default(0) // ITBIS
  hasNcf       Boolean  @default(false) // Explicit flag for "Con Comprobante"

  payments     Payment[]
  creditNotes  CreditNote[]
}

enum Role {
  ADMIN
  SELLER
  ACCOUNTANT
  TECHNICIAN
  MANAGER
  CUSTOM
}

model User {
  id        String        @id @default(cuid())
  name      String
  username  String        @unique
  password  String        // In a real app, hash this. For now, storing as is or simple hash.
  role      Role          @default(SELLER)
  customPermissions Json?  // Permisos personalizados: { canDeleteInvoices: true, canEditProducts: false, ... }
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  invoices     Invoice[]
  quotes       Quote[]
  permissions  Permission?
  dispatches   Dispatch[]  @relation("DispatchTechnician")
}

model Permission {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  permissions Json     // { invoices: { create: true, read: true, update: false, delete: false }, ... }
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  productName String // Snapshot
  quantity  Int
  price     Decimal
}

model Quote {
  id        String      @id @default(cuid())
  clientId  String?
  client    Client?     @relation(fields: [clientId], references: [id])
  total     Decimal
  status    String      @default("PENDING") // PENDING, ACCEPTED, REJECTED
  items     QuoteItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  
  createdById String?
  createdBy   User?       @relation(fields: [createdById], references: [id], onDelete: SetNull)
}

model QuoteItem {
  id        String  @id @default(cuid())
  quoteId   String
  quote     Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  productId String?
  product   Product? @relation(fields: [productId], references: [id])
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  quantity  Int
  price     Decimal
}

model Dispatch {
  id          String         @id @default(cuid())
  invoiceId   String         @unique
  invoice     Invoice        @relation(fields: [invoiceId], references: [id])
  status      String         @default("PENDING") // PENDING, ASSIGNED, IN_PROGRESS, DELIVERED, INSTALLED
  driverName  String?
  technicianId String?
  technician  User?          @relation("DispatchTechnician", fields: [technicianId], references: [id])
  vehicleId   String?
  deliveredAt DateTime?
  installedAt DateTime?
  notes       String?        // Notas de instalaci贸n/entrega
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  photos      DispatchPhoto[]

  @@index([technicianId])
}

model DispatchPhoto {
  id          String   @id @default(cuid())
  dispatchId  String
  dispatch    Dispatch @relation(fields: [dispatchId], references: [id], onDelete: Cascade)
  photoUrl    String   // URL de la foto en storage
  caption     String?  // Descripci贸n opcional
  takenAt     DateTime @default(now())
  takenBy     String?  // ID del usuario que tom贸 la foto
  
  @@index([dispatchId])
}

model Payment {
  id          String   @id @default(cuid())
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  amount      Decimal
  date        DateTime @default(now())
  method      String   // CASH, TRANSFER, CHECK, etc
  reference   String?  // Check #, Transfer ID
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CreditNote {
  id             String   @id @default(cuid())
  sequenceNumber Int      @default(autoincrement())
  invoiceId      String
  invoice        Invoice  @relation(fields: [invoiceId], references: [id])
  reason         String
  total          Decimal
  items          Json?    // Snapshot of items returned { productId, quantity, price }
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Transaction {
  id          String   @id @default(uuid())
  type        String   // INCOME, EXPENSE
  category    String   // SALE, PETTY_CASH, etc
  amount      Decimal
  description String?
  date        DateTime @default(now())
  referenceId String?  // Linked Invoice ID, etc
}

model WorkOrder {
  id          Int      @id @default(autoincrement()) // "ID de Conduce" usually numeric and sequential for easy ref
  invoiceId   String   @unique
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])
  status      String   @default("PRODUCTION") // PRODUCTION, READY, COMPLETED
  notes       String?  // Medidas / Especificaciones
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Setting {
  key   String @id
  value String
}

model Supplier {
  id        String   @id @default(cuid())
  name      String
  phone     String?
  email     String?
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  purchases Purchase[]
}

model Purchase {
  id             String         @id @default(cuid())
  sequenceNumber Int            @default(autoincrement())
  supplierId     String?
  supplier       Supplier?      @relation(fields: [supplierId], references: [id])
  supplierName   String?        // Snapshot or manual entry
  date           DateTime       @default(now())
  total          Decimal
  status         String         @default("COMPLETED") // COMPLETED, CANCELLED
  items          PurchaseItem[]
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
}

model PurchaseItem {
  id         String   @id @default(cuid())
  purchaseId String
  purchase   Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  quantity   Int
  unitCost   Decimal
  total      Decimal
}
